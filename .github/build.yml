name: CI - Build app container

on:
  push:
    branches: [ step6 ]
    paths:
     - 'Dockerfile'
     - '.dockerignore'
     - '.github/workflows/build.yml'
  pull_request:
    branches: [ step6 ]
    paths:
     - 'Dockerfile'
     - '.dockerignore'
     - '.github/workflows/build.yml'

jobs:
  step6:
    runs-on: ubuntu-latest
    env:
      API_KEY: ${{ secrets.OPEN_WHEATHER_API }}
    steps:
     - name: Clone the repository
       uses: actions/checkout@v2
       with:
         fetch-depth: 0  # Shallow clones should be disabled for a better relevancy of analysis
     - name: Build the image
       run: make build
     - name: Read the key into a local environment variable
       run: API_KEY="${{env.API_KEY}}"
     - name: Spin up the container
       run: API_KEY="${{env.API_KEY}}" make run       
     - name: Run the container scanning
       run: make container_scanning
     - name: Upload artifacts
       uses: actions/upload-artifact@v3
       with:
         name: repo-artifact
         path: /home/runner/work/secure-git-workshop/secure-git-workshop/
